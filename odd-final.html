<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Odd One Out</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Righteous&family=Cabin:wght@600;700&family=Archivo:wght@500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Cabin', 'Archivo', sans-serif;
        background: #1a0f0a;
        min-height: 100vh;
        padding: 0;
        position: relative;
        overflow-x: hidden;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            radial-gradient(ellipse 120px 60px at 12% 18%, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.15) 30%, transparent 60%),
            radial-gradient(ellipse 90px 45px at 88% 65%, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.1) 35%, transparent 55%),
            radial-gradient(ellipse 100px 50px at 35% 85%, rgba(0,0,0,0.18) 0%, rgba(0,0,0,0.08) 40%, transparent 60%),
            radial-gradient(ellipse 75px 38px at 68% 25%, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.05) 45%, transparent 65%),
            radial-gradient(ellipse 85px 42px at 50% 50%, rgba(0,0,0,0.12) 0%, transparent 50%),
            repeating-linear-gradient(
                90deg,
                transparent,
                transparent 1px,
                rgba(0,0,0,0.04) 1px,
                rgba(0,0,0,0.04) 2px,
                transparent 2px,
                transparent 4px
            ),
            repeating-linear-gradient(
                90deg,
                #5c4033 0px,
                #6b4d3a 80px,
                #584034 160px,
                #6e5142 240px,
                #5c4033 320px,
                #675040 400px,
                #5c4033 480px
            ),
            repeating-linear-gradient(
                0deg,
                rgba(0,0,0,0.03) 0px,
                transparent 1px,
                rgba(0,0,0,0.02) 2px,
                transparent 3px
            ),
            linear-gradient(
                180deg,
                #5c4033 0%,
                #6b4d3a 50%,
                #5c4033 100%
            );
        pointer-events: none;
    }

    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            repeating-linear-gradient(
                0deg,
                transparent 0px,
                rgba(0,0,0,0.025) 1px,
                transparent 2px,
                rgba(0,0,0,0.015) 3px,
                transparent 6px
            ),
            repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 158px,
                rgba(0,0,0,0.15) 159px,
                rgba(0,0,0,0.2) 160px,
                rgba(0,0,0,0.15) 161px,
                transparent 162px
            );
        pointer-events: none;
        opacity: 0.8;
    }

    .record {
        position: fixed;
        width: 400px;
        height: 400px;
        border-radius: 50%;
        background: 
            radial-gradient(circle at center, #0d0907 20%, transparent 20%, transparent 21%, #0d0907 21%),
            radial-gradient(circle at center, #1a1310 35%, #0d0907 35%, #0d0907 36%, #1a1310 36%),
            radial-gradient(circle at center, #0d0907 50%, #1a1310 50%, #1a1310 51%, #0d0907 51%),
            radial-gradient(circle at center, #1a1310 65%, #0d0907 65%),
            linear-gradient(45deg, #0d0907 25%, transparent 25%, transparent 75%, #0d0907 75%),
            #0d0907;
        box-shadow: 
            0 0 60px rgba(0,0,0,0.9),
            inset 0 0 40px rgba(0,0,0,0.5);
        animation: spin-record 8s linear infinite;
        pointer-events: none;
        opacity: 0.12;
    }

    .record-1 { top: -150px; right: -150px; }
    .record-2 { bottom: -200px; left: -200px; animation-duration: 12s; animation-direction: reverse; opacity: 0.08; }

    @keyframes spin-record {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .light-spot {
        position: fixed;
        border-radius: 50%;
        pointer-events: none;
        filter: blur(60px);
        opacity: 0.15;
        animation: float 10s ease-in-out infinite;
    }

    .light-spot-1 { top: 10%; left: 20%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(251, 191, 36, 0.3), transparent 70%); animation-delay: 0s; }
    .light-spot-2 { bottom: 15%; right: 15%; width: 250px; height: 250px; background: radial-gradient(circle, rgba(217, 119, 6, 0.25), transparent 70%); animation-delay: 3s; }

    @keyframes float {
        0%, 100% { transform: translate(0, 0); }
        33% { transform: translate(-20px, 30px); }
        66% { transform: translate(20px, -20px); }
    }

    .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 48px 24px;
        position: relative;
        z-index: 1;
    }

    h1 {
        font-family: 'Righteous', sans-serif;
        font-size: 4.5rem;
        text-align: center;
        margin-bottom: 12px;
        color: #fbbf24;
        text-shadow: 
            3px 3px 0 rgba(120, 53, 15, 0.6),
            0 0 50px rgba(251, 191, 36, 0.5),
            0 0 80px rgba(217, 119, 6, 0.3);
        letter-spacing: 0.08em;
        filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5));
    }

    h2 {
        font-family: 'Righteous', sans-serif;
        font-size: 2.6rem;
        margin-bottom: 28px;
        color: #fcd34d;
        text-align: center;
        text-shadow: 
            2px 2px 0 rgba(120, 53, 15, 0.4),
            0 0 30px rgba(252, 211, 77, 0.3);
    }

    .subtitle {
        text-align: center;
        color: #fde68a;
        font-size: 1.15rem;
        margin-bottom: 40px;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    }

    .setup-section {
        margin-bottom: 28px;
        background: linear-gradient(135deg, rgba(61, 40, 23, 0.85) 0%, rgba(74, 51, 32, 0.9) 100%);
        backdrop-filter: blur(12px);
        padding: 32px;
        border-radius: 16px;
        border: 3px solid rgba(139, 98, 66, 0.4);
        box-shadow: 
            0 12px 40px rgba(0, 0, 0, 0.7),
            inset 0 1px 0 rgba(251, 191, 36, 0.1),
            inset 0 -2px 8px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .setup-section::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: repeating-linear-gradient(90deg, transparent 0px, rgba(0,0,0,0.05) 1px, transparent 2px, transparent 150px, rgba(139, 98, 66, 0.08) 152px, transparent 154px);
        border-radius: 16px;
        pointer-events: none;
    }

    .mode-toggle { display: flex; gap: 12px; margin-bottom: 24px; }

    .mode-btn {
        flex: 1;
        padding: 16px;
        background: rgba(26, 15, 10, 0.6);
        border: 2px solid rgba(139, 98, 66, 0.3);
        border-radius: 12px;
        color: #fde68a;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-family: 'Cabin', sans-serif;
    }

    .mode-btn:hover { border-color: rgba(139, 98, 66, 0.5); }

    .mode-btn.active {
        background: linear-gradient(135deg, #d97706 0%, #b45309 50%, #92400e 100%);
        border-color: rgba(251, 191, 36, 0.6);
        box-shadow: 0 8px 24px rgba(217, 119, 6, 0.4);
    }

    .room-code-display {
        text-align: center;
        padding: 24px;
        background: rgba(26, 15, 10, 0.8);
        border-radius: 12px;
        border: 2px solid rgba(139, 98, 66, 0.4);
        margin-bottom: 24px;
    }

    .room-code-label { font-size: 0.9rem; color: #fde68a; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em; }
    .room-code { font-family: 'Righteous', sans-serif; font-size: 3rem; color: #fbbf24; letter-spacing: 0.3em; text-shadow: 2px 2px 0 rgba(120, 53, 15, 0.5); }
    .join-instruction { font-size: 0.95rem; color: rgba(253, 230, 138, 0.8); margin-top: 12px; }

    label {
        display: block;
        color: #fde68a;
        font-weight: 700;
        margin-bottom: 12px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    input[type="text"], select, textarea {
        width: 100%;
        padding: 15px 18px;
        background: linear-gradient(135deg, rgba(26, 15, 10, 0.95) 0%, rgba(35, 20, 13, 0.98) 100%);
        border: 2.5px solid rgba(139, 98, 66, 0.5);
        border-radius: 10px;
        color: #fde68a;
        font-size: 1.05rem;
        font-family: 'Cabin', sans-serif;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: inset 0 2px 6px rgba(0,0,0,0.4), 0 1px 0 rgba(251, 191, 36, 0.05);
    }

    input[type="text"]:focus, select:focus, textarea:focus {
        outline: none;
        background: rgba(26, 15, 10, 1);
        border-color: #d97706;
        box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.25), inset 0 2px 6px rgba(0,0,0,0.5), 0 0 20px rgba(217, 119, 6, 0.2);
        transform: translateY(-1px);
    }

    textarea { min-height: 100px; resize: vertical; }

    .btn {
        width: 100%;
        padding: 20px 32px;
        background: linear-gradient(135deg, #d97706 0%, #b45309 50%, #92400e 100%);
        color: #fff;
        border: 3px solid rgba(251, 191, 36, 0.4);
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        font-family: 'Righteous', sans-serif;
        letter-spacing: 0.06em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 8px 24px rgba(217, 119, 6, 0.5), inset 0 1px 0 rgba(251, 191, 36, 0.3), inset 0 -2px 0 rgba(120, 53, 15, 0.5);
        margin-top: 16px;
        position: relative;
        overflow: hidden;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before { left: 100%; }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 32px rgba(217, 119, 6, 0.6), inset 0 1px 0 rgba(251, 191, 36, 0.4), inset 0 -2px 0 rgba(120, 53, 15, 0.6);
        border-color: rgba(251, 191, 36, 0.6);
    }

    .btn:active { transform: translateY(-1px); }

    .btn-secondary {
        background: linear-gradient(135deg, #78350f 0%, #5c2d0e 50%, #451a03 100%);
        border-color: rgba(146, 64, 14, 0.4);
        box-shadow: 0 8px 24px rgba(120, 53, 15, 0.5), inset 0 1px 0 rgba(146, 64, 14, 0.3), inset 0 -2px 0 rgba(69, 26, 3, 0.5);
    }

    .btn-secondary:hover {
        box-shadow: 0 12px 32px rgba(120, 53, 15, 0.6), inset 0 1px 0 rgba(146, 64, 14, 0.4), inset 0 -2px 0 rgba(69, 26, 3, 0.6);
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    .btn-small { width: auto; padding: 13px 26px; font-size: 0.95rem; margin-top: 0; margin-left: 12px; }

    .player-input-container { display: flex; align-items: center; }
    .player-input-container input { margin-bottom: 0; }

    #players-list-setup { margin-top: 20px; }

    .player-item {
        background: rgba(26, 15, 10, 0.7);
        padding: 16px 20px;
        margin-bottom: 12px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid rgba(139, 98, 66, 0.3);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(251, 191, 36, 0.05);
        transition: all 0.2s;
    }

    .player-item:hover { border-color: rgba(139, 98, 66, 0.5); transform: translateX(4px); }

    .player-name { color: #fde68a; font-weight: 700; font-size: 1.05rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

    .remove-btn {
        background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
        color: #fef3c7;
        border: 2px solid rgba(153, 27, 27, 0.4);
        padding: 8px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(153, 27, 27, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .remove-btn:hover { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(153, 27, 27, 0.5); }

    .info-text { color: rgba(253, 230, 138, 0.6); text-align: center; padding: 24px; font-style: italic; font-size: 1rem; }

    .hidden { display: none; }

    .question-box {
        background: linear-gradient(135deg, rgba(61, 40, 23, 0.9) 0%, rgba(74, 51, 32, 0.95) 100%);
        padding: 48px 40px;
        border-radius: 20px;
        text-align: center;
        border: 4px solid rgba(139, 98, 66, 0.5);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.8), inset 0 2px 0 rgba(251, 191, 36, 0.15), inset 0 -4px 12px rgba(0, 0, 0, 0.4);
        margin-bottom: 28px;
        position: relative;
    }

    .question-box::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: repeating-linear-gradient(90deg, transparent 0px, rgba(0,0,0,0.03) 1px, transparent 2px, transparent 120px, rgba(139, 98, 66, 0.06) 122px, transparent 124px);
        border-radius: 20px;
        pointer-events: none;
    }

    .reveal-container h3 { font-family: 'Cabin', sans-serif; font-size: 1.4rem; color: #fde68a; margin-bottom: 20px; font-weight: 700; letter-spacing: 0.03em; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

    .player-display {
        font-family: 'Righteous', sans-serif;
        font-size: 3rem;
        color: #fbbf24;
        margin-bottom: 32px;
        text-shadow: 2px 2px 0 rgba(120, 53, 15, 0.5), 0 0 30px rgba(251, 191, 36, 0.4);
        animation: glow-pulse 2s ease-in-out infinite;
    }

    @keyframes glow-pulse {
        0%, 100% { text-shadow: 2px 2px 0 rgba(120, 53, 15, 0.5), 0 0 30px rgba(251, 191, 36, 0.4); }
        50% { text-shadow: 2px 2px 0 rgba(120, 53, 15, 0.5), 0 0 50px rgba(251, 191, 36, 0.6); }
    }

    .question-text {
        font-family: 'Cabin', sans-serif;
        font-size: 1.6rem;
        color: #fef3c7;
        line-height: 1.6;
        margin-bottom: 24px;
        font-weight: 600;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        font-style: italic;
    }

    .question-text::before, .question-text::after { content: '"'; color: #d97706; font-size: 2rem; font-style: normal; }

    .discussion-info {
        background: rgba(26, 15, 10, 0.8);
        padding: 32px;
        border-radius: 16px;
        margin-bottom: 24px;
        border: 2.5px solid rgba(139, 98, 66, 0.4);
        box-shadow: 0 8px 24px rgba(0,0,0,0.6), inset 0 1px 0 rgba(251, 191, 36, 0.08);
    }

    .discussion-info p { color: #fde68a; font-size: 1.15rem; line-height: 1.8; margin-bottom: 16px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    .discussion-info p:last-child { margin-bottom: 0; }

    .reveal-box {
        background: linear-gradient(135deg, rgba(217, 119, 6, 0.25) 0%, rgba(146, 64, 14, 0.3) 100%);
        padding: 40px;
        border-radius: 16px;
        margin-bottom: 28px;
        border: 3px solid rgba(251, 191, 36, 0.5);
        box-shadow: 0 12px 36px rgba(217, 119, 6, 0.4), inset 0 2px 0 rgba(251, 191, 36, 0.2);
        text-align: center;
    }

    .reveal-box h3 { font-family: 'Righteous', sans-serif; font-size: 1.8rem; color: #fef3c7; margin-bottom: 16px; text-shadow: 2px 2px 0 rgba(120, 53, 15, 0.5); }
    .reveal-box .question-preview { font-size: 1.3rem; color: #fde68a; font-style: italic; margin-bottom: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

    .result-announcement {
        background: linear-gradient(135deg, rgba(217, 119, 6, 0.3) 0%, rgba(146, 64, 14, 0.35) 100%);
        padding: 56px 40px;
        border-radius: 20px;
        text-align: center;
        margin-bottom: 28px;
        border: 4px solid rgba(251, 191, 36, 0.6);
        box-shadow: 0 16px 48px rgba(217, 119, 6, 0.5), inset 0 2px 0 rgba(251, 191, 36, 0.3);
        animation: result-reveal 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes result-reveal {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .result-announcement h3 { font-family: 'Cabin', sans-serif; font-size: 1.5rem; color: #fef3c7; margin-bottom: 20px; font-weight: 700; letter-spacing: 0.05em; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }

    .odd-one-name {
        font-family: 'Righteous', sans-serif;
        font-size: 3.5rem;
        color: #fbbf24;
        margin-bottom: 28px;
        text-shadow: 3px 3px 0 rgba(120, 53, 15, 0.6), 0 0 40px rgba(251, 191, 36, 0.6);
        animation: name-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
    }

    @keyframes name-pop {
        0% { transform: scale(0); }
        100% { transform: scale(1); }
    }

    .button-group { display: flex; gap: 16px; margin-top: 20px; }
    .button-group .btn { margin-top: 0; }

    .steam { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 80px; pointer-events: none; opacity: 0.15; }

    .steam-particle {
        position: absolute;
        bottom: 0; left: 50%;
        width: 8px; height: 8px;
        background: radial-gradient(circle, rgba(251, 191, 36, 0.8), transparent);
        border-radius: 50%;
        animation: rise-steam 4s ease-in-out infinite;
        opacity: 0;
    }

    .steam-particle:nth-child(1) { left: 30%; animation-delay: 0s; }
    .steam-particle:nth-child(2) { left: 50%; animation-delay: 1.3s; }
    .steam-particle:nth-child(3) { left: 70%; animation-delay: 2.6s; }

    @keyframes rise-steam {
        0% { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
        20% { opacity: 0.6; }
        100% { transform: translateY(-80px) translateX(10px) scale(0.3); opacity: 0; }
    }

    @media (max-width: 640px) {
        h1 { font-size: 3rem; }
        h2 { font-size: 2rem; }
        .player-display { font-size: 2.2rem; }
        .question-text { font-size: 1.3rem; }
        .setup-section, .question-box { padding: 24px; }
        .button-group { flex-direction: column; }
        .btn-small { width: 100%; margin-left: 0; margin-top: 12px; }
        .room-code { font-size: 2.2rem; }
    }
</style>
</head>
<body>

<div class="record record-1"></div>
<div class="record record-2"></div>
<div class="light-spot light-spot-1"></div>
<div class="light-spot light-spot-2"></div>

<div class="steam">
    <div class="steam-particle"></div>
    <div class="steam-particle"></div>
    <div class="steam-particle"></div>
</div>

<div class="container">
    <!-- Mode Selection Screen -->
    <div id="mode-screen">
        <h1>Odd One Out</h1>
        <p class="subtitle">One player gets a different question. Can you find them?</p>

        <div class="setup-section">
            <label>How are you playing?</label>
            <div class="mode-toggle" style="margin-bottom: 24px;">
                <button class="mode-btn active" id="mode-btn-local" onclick="selectMode('local', event)">
                    Single Device<br>
                    <small style="font-size: 0.85rem; opacity: 0.8;">Pass & play</small>
                </button>
                <button class="mode-btn" id="mode-btn-multiplayer" onclick="selectMode('multiplayer', event)">
                    Multiplayer<br>
                    <small style="font-size: 0.85rem; opacity: 0.8;">Own phones</small>
                </button>
            </div>

            <div id="mode-name-section">
                <label for="mode-player-name" id="mode-name-label">No name needed â€” you'll add players on the next screen</label>
                <div id="mode-name-input-wrap" class="hidden">
                    <input type="text" id="mode-player-name" placeholder="Enter your name">
                </div>
            </div>

            <button class="btn" onclick="confirmMode()" style="margin-top: 20px;">Continue</button>
        </div>
    </div>

    <!-- Multiplayer Join Screen -->
    <div id="join-screen" class="hidden">
        <h1>Odd One Out</h1>
        <p class="subtitle" id="join-subtitle"></p>

        <div class="setup-section">
            <div class="mode-toggle">
                <button class="mode-btn active" id="create-room-btn" onclick="selectJoinMode('create')">Create Room</button>
                <button class="mode-btn" id="join-room-btn" onclick="selectJoinMode('join')">Join Room</button>
            </div>

            <div id="create-room-section">
                <button class="btn" onclick="createRoom()">Create Room</button>
            </div>

            <div id="join-room-section" class="hidden">
                <label for="join-code">Room Code</label>
                <input type="text" id="join-code" placeholder="Enter 4-digit code" maxlength="4" style="margin-bottom: 16px;">
                <button class="btn" onclick="joinRoom()">Join Room</button>
            </div>
        </div>
    </div>

    <!-- Multiplayer Lobby Screen -->
    <div id="lobby-screen" class="hidden">
        <h1>Odd One Out</h1>
        <p class="subtitle">Waiting for players...</p>

        <div class="room-code-display">
            <div class="room-code-label">Room Code</div>
            <div class="room-code" id="display-room-code">----</div>
            <div class="join-instruction">Share this code with friends to join</div>
        </div>

        <div class="setup-section">
            <label>Players in Room</label>
            <div id="lobby-players-list">
                <p class="info-text">Waiting for players...</p>
            </div>
            <div style="margin-top: 16px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="rename-input" placeholder="Change your name..." style="margin-bottom:0; flex:1;">
                <button class="btn btn-small" style="margin-top:0;" onclick="changeName()">Update</button>
            </div>
        </div>

        <div class="setup-section" id="host-controls" style="display:none">
            <label for="lobby-category">Choose Category</label>
            <select id="lobby-category">
                <option value="stupid">Stupid Questions ðŸ¤ª</option>
                <option value="love">Love & Relationships ðŸ’•</option>
                <option value="social">Social Life ðŸ‘¥</option>
                <option value="lifestyle">Lifestyle & Vibes âœ¨</option>
                <option value="dark">Dark & Deep ðŸŒ‘</option>
                <option value="opinions">Hot Takes & Opinions ðŸ”¥</option>
                <option value="personal">Personal Growth ðŸŒ±</option>
            </select>
            <button class="btn" id="start-game-btn" onclick="startMultiplayerGame()">Start Game</button>
        </div>
    </div>

    <!-- Local Setup Screen -->
    <div id="setup-screen" class="hidden">
        <h1>Odd One Out</h1>
        <p class="subtitle">One player gets a different question. Can you find them?</p>

        <div class="setup-section">
            <label for="new-player-name">Add Players</label>
            <div class="player-input-container">
                <input type="text" id="new-player-name" placeholder="Enter player name">
                <button class="btn btn-small" onclick="addPlayer()">Add</button>
            </div>
            <div id="players-list-setup">
                <p class="info-text">No players added yet</p>
            </div>
        </div>

        <div class="setup-section">
            <label for="category">Choose Category</label>
            <select id="category">
                <option value="stupid">Stupid Questions ðŸ¤ª</option>
                <option value="love">Love & Relationships ðŸ’•</option>
                <option value="social">Social Life ðŸ‘¥</option>
                <option value="lifestyle">Lifestyle & Vibes âœ¨</option>
                <option value="dark">Dark & Deep ðŸŒ‘</option>
                <option value="opinions">Hot Takes & Opinions ðŸ”¥</option>
                <option value="personal">Personal Growth ðŸŒ±</option>
            </select>
        </div>

        <button class="btn" onclick="startGame()">Start Game</button>
    </div>

    <!-- Question Screen -->
    <div id="question-screen" class="hidden">
        <h2>Your Turn</h2>

        <div class="question-box" id="reveal-container">
            <div class="reveal-container">
                <h3>Get ready...</h3>
                <div class="player-display" id="current-player-name"></div>
                <button class="btn" onclick="revealQuestion()">Show My Question</button>
            </div>
        </div>

        <div class="question-box hidden" id="question-container">
            <p class="question-text" id="question-text"></p>
            <button class="btn btn-secondary" id="next-btn" onclick="nextPlayer()">Next Player</button>
        </div>
    </div>

    <!-- Multiplayer Question Screen -->
    <div id="multiplayer-question-screen" class="hidden">
        <div id="mp-question-view">
            <h2>Your Question</h2>
            <div class="question-box">
                <p class="question-text" id="multiplayer-question-text"></p>
            </div>
            <div class="setup-section">
                <label for="player-answer">Your Answer</label>
                <input type="text" id="player-answer" placeholder="Type your answer here...">
            </div>
            <button class="btn" onclick="lockInAnswer()">Lock In Answer</button>
        </div>

        <div id="mp-answer-view" class="hidden">
            <h2>Your Answer</h2>
            <div class="question-box" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                <p class="question-text" id="locked-answer-display" style="font-size: 2.2rem;"></p>
            </div>
            
            <div id="host-controls-answer-view" class="hidden">
                <button class="btn btn-secondary" onclick="toggleBackToQuestion()" id="toggle-back-btn" style="margin-bottom: 12px;">Show My Question</button>
                <button class="btn" onclick="moveToDiscussion()">Show Everyone's Answers</button>
            </div>
            
            <div id="guest-waiting-view">
                <p class="info-text">Waiting for host to show everyone's answers...</p>
            </div>
        </div>
    </div>

    <!-- Answers Board Screen -->
    <div id="answers-screen" class="hidden">
        <h2 style="margin-bottom: 32px;">Everyone's Answers</h2>
        
        <div id="answers-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px;"></div>

        <div id="majority-question-display" class="hidden" style="margin-bottom: 32px;">
            <div class="reveal-box" style="padding: 56px 40px;">
                <h3 style="font-size: 1.8rem; margin-bottom: 20px; color: #fef3c7;">Most players got:</h3>
                <p class="question-preview" style="font-size: 1.8rem;" id="majority-q-text"></p>
            </div>
        </div>

        <div id="host-answers-controls" class="hidden">
            <button class="btn btn-secondary" onclick="toggleMajorityQuestion()" id="toggle-question-btn">Show the Question</button>
            <button class="btn" onclick="showQuestionsReveal()" style="margin-top: 12px;">Continue to Reveal</button>
        </div>
        <div id="guest-answers-waiting">
            <p class="info-text" style="margin-top: 16px;">Waiting for host to continue...</p>
        </div>
    </div>

    <div id="questions-reveal-screen" class="hidden">
        <h2>The Majority Got...</h2>
        <div class="reveal-box">
            <p class="question-preview" id="normal-question-reveal"></p>
        </div>
        <button class="btn" onclick="showOddOneOut()">Reveal the Odd One Out</button>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="hidden">
        <h2>The Odd One Out Was...</h2>

        <div class="result-announcement">
            <h3>It was...</h3>
            <div class="odd-one-name" id="odd-one-name"></div>
        </div>

        <div class="reveal-box">
            <h3>Their question was:</h3>
            <p class="question-preview" id="odd-question-reveal"></p>
        </div>

        <div class="button-group">
            <button class="btn" onclick="playAgain()">Play Again</button>
            <button class="btn btn-secondary" onclick="resetGame()">Leave Room</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBNLimf247SRwWbn3gCFOz4agt9AsoogYI",
        authDomain: "dynamitetwinkie-7b197.firebaseapp.com",
        databaseURL: "https://dynamitetwinkie-7b197-default-rtdb.firebaseio.com",
        projectId: "dynamitetwinkie-7b197",
        storageBucket: "dynamitetwinkie-7b197.firebasestorage.app",
        messagingSenderId: "644017159848",
        appId: "1:644017159848:web:45d61846f1977ba650cc9d"
    };

    let database = null;
    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
    } catch (error) {
        console.error('Firebase initialization error:', error);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // QUESTION DATABASE
    // Pairs are CONVERGENT, not opposite. Both players answer about the same
    // general topic, but the framing pulls answers in subtly different directions.
    // e.g. "what game requires the most skill?" vs "what game would you play with kids?"
    // â€” both get game answers, but the odd one out's answer sounds just a bit off.
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const questionDatabase = {
        stupid: {
            normal: [
                // Songs
                "What song do you put on when you need to hype yourself up?",
                // Animals
                "What's the coolest animal that exists?",
                // Food
                "What's the best food to eat at 2am?",
                // Skills / talents
                "What's a skill that would actually impress people at a party?",
                // Superpowers
                "What superpower would make your everyday life genuinely easier?",
                // Hypothetical swaps
                "What celebrity would you want to switch brains with for a day?",
                // Invisible
                "What's the first thing you'd do if you turned invisible?",
                // Survival
                "What's one thing you'd want with you if you were stranded in the wilderness?",
                // Fight
                "How many 10-year-olds do you think you could fight off at once? (answer with a number)",
                // Money / dare
                "How much money would it take for you to shave your head right now? ($ amount)",
                // Emoji â€” best
                "What's the best emoji to use when you want someone to know you're joking?",
                "What emoji do you use the most?",
                "What's the most powerful emoji in the entire emoji keyboard?",
                "What emoji perfectly captures how you feel on a Monday morning?",
                // Zombie
                "What animal would you want on your side in a zombie apocalypse?",
                // Fictional worlds
                "What fictional universe would you actually want to live in?",
                // Dumb hypothetical
                "What random object in this room would be your weapon if you had to defend yourself right now?",
                // Gas station
                "How many days could you survive eating only gas station food? (answer with a number)",
                // Useless skills
                "What's something completely pointless that you're actually pretty good at?"
            ],
            odd: [
                // Songs â€” same vibe, different context
                "What song do you always hear at the grocery store?",
                // Animals â€” same space, different pull
                "What's the most useless animal you can think of?",
                // Food â€” same late-night energy but skews differently
                "What's the best gas station snack?",
                // Skills â€” still impressive but different tier
                "What's a skill that sounds impressive but is actually pretty easy to learn?",
                // Superpowers â€” still practical but goofier answers expected
                "What superpower sounds amazing but would actually be kind of annoying to have?",
                // Hypothetical swaps â€” same format, different pull
                "What fictional character would you want to switch brains with for a day?",
                // Invisible â€” same premise, goofier angle
                "What's something boring you'd probably end up doing if you turned invisible?",
                // Survival â€” same stranded premise, different answers expected
                "What's one thing you'd want with you if you were stranded on a desert island?",
                // Fight â€” same fight premise, different framing â†’ different numbers
                "How many 10-year-olds do you think it would realistically take to beat you in a fight? (answer with a number)",
                // Money / dare â€” same money game, different stakes
                "How much money would it take for you to eat a live bug on camera? ($ amount)",
                // Emoji â€” FBI version
                "What's the worst emoji someone could reply with when you text the FBI tip line?",
                "What emoji do other people use that you genuinely hate?",
                "What's the most passive-aggressive emoji in existence?",
                "What emoji would you use to describe your most chaotic friend?",
                // Zombie â€” same apocalypse, different angle
                "What household object would actually be your zombie apocalypse weapon?",
                // Fictional worlds â€” same concept, skews differently
                "What fictional universe sounds cool but would actually be terrifying to live in?",
                // Dumb hypothetical â€” same premise, different framing
                "What random object in this room would be completely useless if you had to defend yourself?",
                // Survival show â€” similar number premise
                "How many hours into a wilderness survival show before you'd tap out? (answer with a number)",
                // Useless skills â€” same theme, different skew
                "What's something you're weirdly bad at considering how basic it is?"
            ]
        },
        love: {
            normal: [
                // What you look for / want
                "What's a quality you look for in a partner that most people wouldn't think to mention?",
                "What's your ideal first date?",
                "What's something a partner does that makes you feel really cared for?",
                "What does a healthy relationship actually look like to you?",
                "What's a green flag you always notice early on?",
                "What's your love language?",
                "What's something romantic that actually works on you?",
                "What's a dealbreaker that might surprise people?",
                "How do you usually show someone you like them?",
                "What's something you think is underrated in a relationship?",
                "What's the most romantic thing someone's ever done for you?",
                "What kind of person do you tend to fall for?",
                // Number questions â€” same topic, different framing
                "How many dates do you usually go on before you know if you actually like someone? (number)",
                "On a scale of 1â€“10, how important is physical attraction vs personality to you? (number)",
                "How many texts a day from someone new feels like the right amount? (number)"
            ],
            odd: [
                // What you notice / observe â€” same relationship space, just a different angle
                "What's a quality that seems attractive at first but ends up being a red flag?",
                "What's the worst first date idea that people think is romantic?",
                "What's something a partner does that people find sweet but you find kind of annoying?",
                "What does an unhealthy relationship usually look like from the outside?",
                "What's a red flag people always ignore at the start?",
                "What love language do you find hardest to deal with in a partner?",
                "What's something people think is romantic but is actually kind of cringe?",
                "What's a dealbreaker that most people would judge you for having?",
                "What's something people do to show they like someone that usually backfires?",
                "What's something that gets way too much credit in a relationship?",
                "What's the most awkward or embarrassing date you've been on?",
                "What type of person do your friends always warn you about but you go for anyway?",
                // Number questions â€” same topic, different framing
                "How many dates does it usually take before you can tell it's not going anywhere? (number)",
                "On a scale of 1â€“10, how much does someone's music taste affect whether you'd date them? (number)",
                "How many texts a day before it starts feeling like too much from someone new? (number)"
            ]
        },
        social: {
            normal: [
                "What's your go-to move at a party when you don't know many people?",
                "What kind of person do you always end up talking to at a party?",
                "What's something you do that tends to make people like you quickly?",
                "What's the best kind of social hangout?",
                "What makes someone genuinely fun to be around?",
                "What's something about you that people are always surprised to find out?",
                "What do you think your friends would say is your best quality?",
                "What's a topic you can always get a good conversation going about?",
                "What's your go-to thing to talk about when meeting someone new?",
                "What's a social situation you're actually pretty good at?",
                // Number questions
                "How many people would you say you're genuinely close with? (number)",
                "On a scale of 1â€“10, how much do you enjoy being around large groups of people? (number)",
                "How many hours is the ideal hangout before you start wanting to go home? (number)"
            ],
            odd: [
                "What's your move when you're trapped in a conversation you want to escape?",
                "What kind of person do you always end up stuck talking to at a party?",
                "What's something you do socially that you know is kind of a bad habit?",
                "What's the most overrated type of social hangout?",
                "What's something people do that they think makes them fun but actually doesn't?",
                "What's something about you that tends to catch people off guard in a bad way?",
                "What do you think your friends would say is your most annoying quality?",
                "What's a topic that you accidentally make awkward every time it comes up?",
                "What's your go-to when a conversation starts dying and you panic?",
                "What's a social situation you're secretly terrible at?",
                // Number questions
                "How many people in a room before it starts feeling overwhelming? (number)",
                "On a scale of 1â€“10, how much do you dread small talk? (number)",
                "How many hours into a hangout before you start thinking about leaving? (number)"
            ]
        },
        lifestyle: {
            normal: [
                "What's a show you'd recommend to literally anyone?",
                "What's your go-to comfort food?",
                "What's something you're surprisingly good at?",
                "What's your ideal way to spend a day off?",
                "What's a habit you have that genuinely makes your life better?",
                "What's something you could talk about for hours without getting bored?",
                "What's your go-to order at a restaurant when you can't decide?",
                "What's a hobby or activity you think more people should try?",
                "What's a small thing that reliably puts you in a good mood?",
                "What's something about your daily routine that you actually like?",
                // Number questions
                "How many hours of sleep do you need to feel like a human? (number)",
                "On a scale of 1â€“10, how much of a morning person are you? (number)",
                "How many hours a week do you spend doing something just for fun? (number)"
            ],
            odd: [
                "What's a show everyone loves that you just can't get into?",
                "What's a comfort food people swear by that you think is kind of disgusting?",
                "What's something you're weirdly bad at for your age?",
                "What's your ideal day off look like if you're being totally honest?",
                "What's a habit you have that you know is bad but won't quit?",
                "What's something you could easily spend hours doing that people would judge you for?",
                "What's your go-to order when you're not in the mood to think?",
                "What's a hobby or activity you've tried and genuinely hated?",
                "What's a small thing that reliably puts you in a bad mood?",
                "What's something about your daily routine that you kind of hate but keep doing?",
                // Number questions
                "How many hours of sleep do you actually get most nights? (number)",
                "On a scale of 1â€“10, how chaotic is your average morning? (number)",
                "How many hours a week do you spend doing something you feel guilty about? (number)"
            ]
        },
        dark: {
            normal: [
                "What's something most people would be too embarrassed to admit they enjoy?",
                "What's the pettiest thing you've ever done that you don't actually regret?",
                "What's something you've lied about that you'd probably lie about again?",
                "What's a thought you've had that you'd never say out loud?",
                "What's something you judge people for even though you know you shouldn't?",
                "What's a version of yourself you'd be embarrassed to explain to someone who just met you?",
                "What's a slightly sketchy thing you do that you've just accepted about yourself?",
                "What's something everyone does but nobody talks about?",
                "What's the most selfish thing you've done that you're kind of fine with?",
                "What's an opinion you hold that would make some people uncomfortable?",
                // Number questions
                "How much money would it take to get you to run naked down a busy street? ($ amount)",
                "On a scale of 1â€“10, how ruthless are you when you really want something? (number)",
                "How many of your close friends do you think actually know the real you? (number)"
            ],
            odd: [
                "What's something that everyone pretends to enjoy but probably doesn't?",
                "What's the pettiest thing you've seen someone else do that you secretly found hilarious?",
                "What's something people lie about all the time that's completely pointless to lie about?",
                "What's a thought you've had that you suspect everyone has but nobody says?",
                "What's something people get judged for that you think is actually totally fine?",
                "What's a version of yourself from a few years ago you'd be embarrassed to explain?",
                "What's a slightly sketchy thing most people probably do but act like they don't?",
                "What's something society pretends is normal but is actually kind of weird when you think about it?",
                "What's the most selfish thing most people do without realizing it?",
                "What's an opinion that's technically controversial but you think most people secretly agree with?",
                // Number questions
                "How much money would it take to get you to tell your most embarrassing secret to the whole group right now? ($ amount)",
                "On a scale of 1â€“10, how vindictive are you when someone wrongs you? (number)",
                "How many of your close friends would actually show up for you in a real crisis? (number)"
            ]
        },
        opinions: {
            normal: [
                "What's a food that is objectively better than people give it credit for?",
                "What's a movie that more people should have seen?",
                "What's an opinion about dating that most people your age would agree with?",
                "What's something that's genuinely worth spending money on?",
                "What game requires the most actual skill?",
                "What's a social media platform that actually has value?",
                "What's something that was better before it got popular?",
                "What's a life skill everyone should learn?",
                "What's a type of music that gets unfairly dismissed?",
                "What's something people treat as a big deal that really isn't?",
                // Number questions
                "On a scale of 1â€“10, how strongly do you hold your opinions once you've formed them? (number)",
                "How many minutes would it take for someone to change your mind on something you believe in? (number)",
                "Out of your 10 closest friends, how many do you think share your general worldview? (number)"
            ],
            odd: [
                "What's a food that people rave about that you think is massively overrated?",
                "What's a movie that way too many people have seen and talked about?",
                "What's an opinion about dating that your parents' generation would agree with?",
                "What's something people spend money on that's a complete waste?",
                "What game would you play with your kids?",
                "What's a social media platform that has done more harm than good?",
                "What's something that got better once it became more popular?",
                "What's a life skill people think is essential that you could actually live without?",
                "What's a type of music that honestly deserves the hate it gets?",
                "What's something people treat as unimportant that actually matters a lot?",
                // Number questions
                "On a scale of 1â€“10, how quickly do you form an opinion about someone when you first meet them? (number)",
                "How many minutes into an argument before you've already made up your mind? (number)",
                "Out of your 10 closest friends, how many do you think secretly disagree with you on important stuff? (number)"
            ]
        },
        personal: {
            normal: [
                "What's something you've gotten noticeably better at in the past year?",
                "What's a goal you've actually been making progress on?",
                "What's something about yourself that you're glad you figured out?",
                "What's the best advice you ever got?",
                "What's a habit that's made a real difference in your life?",
                "What's a strength of yours that people might not see right away?",
                "What's something you're genuinely looking forward to?",
                "What's something you've changed your mind about as you've gotten older?",
                "What's a version of yourself you're proud to have become?",
                "What's something you handle better now than you did a few years ago?",
                // Number questions
                "On a scale of 1â€“10, how happy are you with where your life is right now? (number)",
                "How many years from now do you think you'll be where you want to be? (number)",
                "Out of 10, how much do you feel like you're living according to your own values? (number)"
            ],
            odd: [
                "What's something you keep saying you'll get better at but haven't yet?",
                "What's a goal you've been carrying around for so long it barely feels real anymore?",
                "What's something about yourself you're still trying to figure out?",
                "What's a piece of advice you've gotten that turned out to be wrong for you?",
                "What's a habit you know you should build but keep putting off?",
                "What's a weakness of yours that you've mostly just learned to work around?",
                "What's something you're kind of dreading about the future?",
                "What's something you thought you believed but now you're not so sure about?",
                "What's a version of yourself from the past you're still a little bit like?",
                "What's something you still handle worse than you'd like to admit?",
                // Number questions
                "On a scale of 1â€“10, how much do you think about who you want to be vs. just living day to day? (number)",
                "How many years do you think you've spent doing something out of obligation rather than actual want? (number)",
                "Out of 10, how much work do you think you still have to do on yourself? (number)"
            ]
        }
    };

    let gameState = {
        mode: 'local',
        players: [],
        category: 'love',
        currentPlayerIndex: 0,
        oddOneIndex: -1,
        normalQuestion: '',
        oddQuestion: '',
        phase: 'mode-selection',
        roomCode: null,
        isHost: false,
        playerName: ''
    };

    function selectMode(mode, event) {
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.mode-btn').classList.add('active');
        gameState.mode = mode;

        const label = document.getElementById('mode-name-label');
        const inputWrap = document.getElementById('mode-name-input-wrap');

        if (mode === 'multiplayer') {
            label.textContent = 'Your name';
            inputWrap.classList.remove('hidden');
            document.getElementById('mode-player-name').focus();
        } else {
            label.textContent = "No name needed â€” you'll add players on the next screen";
            inputWrap.classList.add('hidden');
        }
    }

    function confirmMode() {
        if (gameState.mode === 'multiplayer') {
            const name = document.getElementById('mode-player-name').value.trim();
            if (!name) { alert('Please enter your name first!'); return; }
            gameState.playerName = name;
            document.getElementById('join-subtitle').textContent = 'Hey ' + name + '! Create or join a room.';
            showScreen('join-screen');
        } else {
            showScreen('setup-screen');
        }
    }

    function selectJoinMode(mode) {
        const createBtn = document.getElementById('create-room-btn');
        const joinBtn = document.getElementById('join-room-btn');
        const createSection = document.getElementById('create-room-section');
        const joinSection = document.getElementById('join-room-section');

        if (mode === 'create') {
            createBtn.classList.add('active'); joinBtn.classList.remove('active');
            createSection.classList.remove('hidden'); joinSection.classList.add('hidden');
        } else {
            joinBtn.classList.add('active'); createBtn.classList.remove('active');
            joinSection.classList.remove('hidden'); createSection.classList.add('hidden');
        }
    }

    function generateRoomCode() {
        return Math.floor(1000 + Math.random() * 9000).toString();
    }

    function createRoom() {
        const hostName = gameState.playerName;
        if (!hostName) { alert('Something went wrong â€” no name found. Please go back and enter your name.'); return; }
        if (!database) { alert('Firebase is not configured!'); return; }

        gameState.roomCode = generateRoomCode();
        gameState.isHost = true;

        const roomRef = database.ref('rooms/' + gameState.roomCode);
        roomRef.set({
            host: hostName,
            players: { [sanitizeKey(hostName)]: hostName },
            category: 'love',
            gameStarted: false,
            phase: 'lobby',
            createdAt: Date.now()
        }).then(() => {
            gameState.roomRef = roomRef;
            setupPresence(roomRef, hostName, true);
            attachRoomListener(roomRef);
            document.getElementById('display-room-code').textContent = gameState.roomCode;
            document.getElementById('host-controls').style.display = 'block';
            showScreen('lobby-screen');
        }).catch((error) => { alert('Error creating room: ' + error.message); });
    }

    function joinRoom() {
        const roomCode = document.getElementById('join-code').value.trim();
        const playerName = gameState.playerName;

        if (!roomCode || roomCode.length !== 4) { alert('Please enter a valid 4-digit room code!'); return; }
        if (!playerName) { alert('Something went wrong â€” no name found.'); return; }
        if (!database) { alert('Firebase is not configured!'); return; }

        gameState.roomCode = roomCode;
        gameState.isHost = false;

        const roomRef = database.ref('rooms/' + roomCode);
        roomRef.once('value').then((snapshot) => {
            if (!snapshot.exists()) { alert('Room not found! Check the code and try again.'); return; }

            const roomData = snapshot.val();
            if (roomData.gameStarted) { alert('Game has already started!'); return; }

            const players = roomData.players || {};
            const takenNames = Object.values(players).map(n => n.toLowerCase());
            if (takenNames.includes(playerName.toLowerCase())) { alert('This name is already in use! Please choose a different name.'); return; }

            const playerKey = sanitizeKey(playerName);
            roomRef.child('players/' + playerKey).set(playerName).then(() => {
                gameState.roomRef = roomRef;
                setupPresence(roomRef, playerName, false);
                attachRoomListener(roomRef);
                document.getElementById('display-room-code').textContent = roomCode;
                showScreen('lobby-screen');
            });
        }).catch((error) => { alert('Error joining room: ' + error.message); });
    }

    function updateLobby(roomData) {
        const playersList = document.getElementById('lobby-players-list');
        const players = roomData.players || {};
        const playerNames = Object.values(players);

        if (playerNames.length === 0) { playersList.innerHTML = '<p class="info-text">Waiting for players...</p>'; return; }

        playersList.innerHTML = playerNames.map(name => `
            <div class="player-item">
                <span class="player-name">${name}${name === roomData.host ? ' (Host)' : ''}</span>
            </div>
        `).join('');

        if (gameState.isHost) document.getElementById('host-controls').style.display = 'block';
    }

    function startMultiplayerGame() {
        if (!gameState.isHost) return;

        const roomRef = database.ref('rooms/' + gameState.roomCode);
        roomRef.once('value').then((snapshot) => {
            const roomData = snapshot.val();
            const playerNames = Object.values(roomData.players || {});

            if (playerNames.length < 3) { alert('You need at least 3 players!'); return; }

            const category = document.getElementById('lobby-category').value;
            const questions = questionDatabase[category];
            const normalIndex = Math.floor(Math.random() * questions.normal.length);
            const oddIndex = Math.floor(Math.random() * questions.odd.length);
            const oddOneIndex = Math.floor(Math.random() * playerNames.length);

            const btn = document.getElementById('start-game-btn');
            btn.disabled = true; btn.textContent = 'Starting...';

            roomRef.update({
                gameStarted: true,
                phase: 'question',
                category: category,
                normalQuestion: questions.normal[normalIndex],
                oddQuestion: questions.odd[oddIndex],
                oddOneIndex: oddOneIndex,
                oddOneName: playerNames[oddOneIndex],
                answers: null
            });
        });
    }

    function showMultiplayerQuestion(roomData) {
        const playerNames = Object.values(roomData.players || {});
        const playerIndex = playerNames.indexOf(gameState.playerName);
        const isOddOne = playerIndex === roomData.oddOneIndex;
        const question = isOddOne ? roomData.oddQuestion : roomData.normalQuestion;

        document.getElementById('multiplayer-question-text').textContent = question;
        document.getElementById('player-answer').value = '';
        document.getElementById('mp-question-view').classList.remove('hidden');
        document.getElementById('mp-answer-view').classList.add('hidden');

        showScreen('multiplayer-question-screen');
    }

    function lockInAnswer() {
        const answer = document.getElementById('player-answer').value.trim();
        if (!answer) { alert('Please type an answer first!'); return; }
        if (!database) { alert('Firebase is not connected!'); return; }

        const roomRef = database.ref('rooms/' + gameState.roomCode);
        const answerKey = 'answers/' + sanitizeKey(gameState.playerName);

        roomRef.child(answerKey).set(answer).then(() => {
            document.getElementById('locked-answer-display').textContent = `"${answer}"`;
            document.getElementById('mp-question-view').classList.add('hidden');
            document.getElementById('mp-answer-view').classList.remove('hidden');

            if (gameState.isHost) {
                document.getElementById('host-controls-answer-view').classList.remove('hidden');
                document.getElementById('guest-waiting-view').classList.add('hidden');
            } else {
                document.getElementById('host-controls-answer-view').classList.add('hidden');
                document.getElementById('guest-waiting-view').classList.remove('hidden');
            }
            viewingOwnQuestion = false;
        }).catch((error) => { alert('Failed to save answer: ' + error.message); });
    }

    let viewingOwnQuestion = false;
    function toggleBackToQuestion() {
        const btn = document.getElementById('toggle-back-btn');
        const displayText = document.getElementById('locked-answer-display');

        if (!viewingOwnQuestion) {
            const myQuestion = document.getElementById('multiplayer-question-text').textContent;
            displayText.textContent = myQuestion;
            btn.textContent = 'Show My Answer';
            viewingOwnQuestion = true;
        } else {
            const myAnswer = document.getElementById('player-answer').value.trim();
            displayText.textContent = `"${myAnswer}"`;
            btn.textContent = 'Show My Question';
            viewingOwnQuestion = false;
        }
    }

    function moveToDiscussion() {
        const roomRef = database.ref('rooms/' + gameState.roomCode);
        roomRef.update({ phase: 'answers' });
    }

    function showAnswersScreen(roomData) {
        const playerNames = Object.values(roomData.players || {});
        const answers = roomData.answers || {};

        const grid = document.getElementById('answers-grid');
        const majorityDisplay = document.getElementById('majority-question-display');

        grid.classList.remove('hidden');
        majorityDisplay.classList.add('hidden');

        grid.innerHTML = playerNames.map(name => {
            const key = sanitizeKey(name);
            const answer = answers[key] || '(no answer yet)';
            return `
                <div style="
                    background: linear-gradient(135deg, rgba(61, 40, 23, 0.9) 0%, rgba(74, 51, 32, 0.95) 100%);
                    padding: 32px 28px;
                    border-radius: 16px;
                    border: 3px solid rgba(139, 98, 66, 0.5);
                    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
                    min-height: 200px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                    gap: 16px;
                ">
                    <div style="font-family: 'Righteous', sans-serif; font-size: 1.4rem; color: #fbbf24; text-shadow: 2px 2px 0 rgba(120, 53, 15, 0.5);">${name}</div>
                    <div style="color: #fef3c7; font-size: 1.3rem; font-style: italic; line-height: 1.5; font-weight: 600;">"${answer}"</div>
                </div>
            `;
        }).join('');

        showingMajorityQuestion = false;
        document.getElementById('toggle-question-btn').textContent = 'Show the Question';

        if (gameState.isHost) {
            document.getElementById('host-answers-controls').classList.remove('hidden');
            document.getElementById('guest-answers-waiting').classList.add('hidden');
        } else {
            document.getElementById('host-answers-controls').classList.add('hidden');
            document.getElementById('guest-answers-waiting').classList.remove('hidden');
        }

        showScreen('answers-screen');
    }

    let showingMajorityQuestion = false;
    function toggleMajorityQuestion() {
        const btn = document.getElementById('toggle-question-btn');
        const grid = document.getElementById('answers-grid');
        const questionDisplay = document.getElementById('majority-question-display');
        const questionText = document.getElementById('majority-q-text');

        if (!showingMajorityQuestion) {
            grid.classList.add('hidden');
            questionDisplay.classList.remove('hidden');
            questionText.textContent = `"${gameState.normalQuestion}"`;
            btn.textContent = 'Show Answers';
            showingMajorityQuestion = true;
        } else {
            questionDisplay.classList.add('hidden');
            grid.classList.remove('hidden');
            btn.textContent = 'Show the Question';
            showingMajorityQuestion = false;
        }
    }

    function sanitizeKey(name) {
        return name.replace(/[.#$[\]/]/g, '_').toLowerCase();
    }

    function setupPresence(roomRef, playerName, isHost) {
        const playerKey = sanitizeKey(playerName);
        if (isHost) { roomRef.onDisconnect().remove(); }
        else { roomRef.child('players/' + playerKey).onDisconnect().remove(); }

        window.addEventListener('beforeunload', () => {
            if (isHost) roomRef.remove();
            else roomRef.child('players/' + playerKey).remove();
        });
    }

    function changeName() {
        const input = document.getElementById('rename-input');
        const newName = input.value.trim();
        if (!newName) { alert('Please enter a name!'); return; }
        if (newName === gameState.playerName) { input.value = ''; return; }

        const roomRef = database.ref('rooms/' + gameState.roomCode);
        roomRef.once('value').then(snapshot => {
            const roomData = snapshot.val();
            const taken = Object.values(roomData.players || {}).map(n => n.toLowerCase());
            if (taken.includes(newName.toLowerCase())) { alert('That name is already taken!'); return; }

            const oldKey = sanitizeKey(gameState.playerName);
            const newKey = sanitizeKey(newName);

            roomRef.child('players/' + oldKey).remove();
            roomRef.child('players/' + newKey).set(newName);

            if (gameState.isHost) {
                roomRef.update({ host: newName });
                roomRef.onDisconnect().remove();
            } else {
                roomRef.child('players/' + oldKey).onDisconnect().cancel();
                roomRef.child('players/' + newKey).onDisconnect().remove();
            }

            gameState.playerName = newName;
            input.value = '';
        });
    }

    function attachRoomListener(roomRef) {
        roomRef.on('value', (snapshot) => {
            const roomData = snapshot.val();

            if (!roomData) {
                if (!gameState.isHost) { alert('The host has left. The room is closed.'); hardReset(); }
                return;
            }

            const phase = roomData.phase;

            if (phase === 'lobby') { updateLobby(roomData); return; }

            if (phase === 'question' && gameState.phase !== 'question') {
                gameState.phase = 'question';
                gameState.normalQuestion = roomData.normalQuestion;
                gameState.oddQuestion = roomData.oddQuestion;
                gameState.oddOneName = roomData.oddOneName;
                gameState.oddOneIndex = roomData.oddOneIndex;
                const btn = document.getElementById('start-game-btn');
                if (btn) { btn.disabled = false; btn.textContent = 'Start Game'; }
                showMultiplayerQuestion(roomData);
                return;
            }

            if (phase === 'answers' && gameState.phase !== 'answers') {
                gameState.phase = 'answers';
                setTimeout(() => {
                    roomRef.once('value').then(snap => { showAnswersScreen(snap.val()); });
                }, 200);
                return;
            }

            if (phase === 'reveal' && gameState.phase !== 'reveal') {
                gameState.phase = 'reveal';
                showQuestionsReveal();
                return;
            }
        });
    }

    function hardReset() {
        gameState = { mode: 'local', players: [], category: 'love', currentPlayerIndex: 0, oddOneIndex: -1, normalQuestion: '', oddQuestion: '', phase: 'mode-selection', roomCode: null, isHost: false, playerName: '' };
        showScreen('mode-screen');
    }

    // â”€â”€ Local game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('new-player-name').addEventListener('keypress', function(e) { if (e.key === 'Enter') addPlayer(); });

    const modePlayerName = document.getElementById('mode-player-name');
    if (modePlayerName) modePlayerName.addEventListener('keypress', function(e) { if (e.key === 'Enter') confirmMode(); });

    const joinCode = document.getElementById('join-code');
    if (joinCode) joinCode.addEventListener('keypress', function(e) { if (e.key === 'Enter') joinRoom(); });

    const renameInput = document.getElementById('rename-input');
    if (renameInput) renameInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') changeName(); });

    const playerAnswer = document.getElementById('player-answer');
    if (playerAnswer) playerAnswer.addEventListener('keypress', function(e) { if (e.key === 'Enter') lockInAnswer(); });

    function addPlayer() {
        const input = document.getElementById('new-player-name');
        const name = input.value.trim();
        if (!name) { alert('Please enter a name!'); return; }
        if (gameState.players.includes(name)) { alert('This name is already added!'); return; }
        gameState.players.push(name);
        input.value = '';
        updatePlayersList();
    }

    function removePlayer(index) {
        gameState.players.splice(index, 1);
        updatePlayersList();
    }

    function updatePlayersList() {
        const list = document.getElementById('players-list-setup');
        if (gameState.players.length === 0) { list.innerHTML = '<p class="info-text">No players added yet</p>'; return; }
        list.innerHTML = gameState.players.map((player, index) => `
            <div class="player-item">
                <span class="player-name">${player}</span>
                <button class="remove-btn" onclick="removePlayer(${index})">Remove</button>
            </div>
        `).join('');
    }

    function startGame() {
        if (gameState.players.length < 3) { alert('You need at least 3 players!'); return; }

        gameState.category = document.getElementById('category').value;
        gameState.currentPlayerIndex = 0;

        const questions = questionDatabase[gameState.category];
        const normalIndex = Math.floor(Math.random() * questions.normal.length);
        const oddIndex = Math.floor(Math.random() * questions.odd.length);

        gameState.normalQuestion = questions.normal[normalIndex];
        gameState.oddQuestion = questions.odd[oddIndex];
        gameState.oddOneIndex = Math.floor(Math.random() * gameState.players.length);

        showQuestion();
    }

    function showQuestion() {
        const playerName = gameState.players[gameState.currentPlayerIndex];
        document.getElementById('current-player-name').textContent = playerName;
        document.getElementById('reveal-container').classList.remove('hidden');
        document.getElementById('question-container').classList.add('hidden');
        document.getElementById('next-btn').disabled = true;
        showScreen('question-screen');
    }

    function revealQuestion() {
        const isOddOne = gameState.currentPlayerIndex === gameState.oddOneIndex;
        const question = isOddOne ? gameState.oddQuestion : gameState.normalQuestion;
        document.getElementById('question-text').textContent = question;
        document.getElementById('reveal-container').classList.add('hidden');
        document.getElementById('question-container').classList.remove('hidden');
        document.getElementById('next-btn').disabled = false;
    }

    function nextPlayer() {
        gameState.currentPlayerIndex++;
        if (gameState.currentPlayerIndex >= gameState.players.length) {
            showDiscussion();
        } else {
            showQuestion();
        }
    }

    function showDiscussion() {
        showScreen('discussion-screen');
    }

    function showQuestionsReveal() {
        if (gameState.mode === 'multiplayer') {
            database.ref('rooms/' + gameState.roomCode).update({ phase: 'reveal' });
        }
        document.getElementById('normal-question-reveal').textContent = `"${gameState.normalQuestion}"`;
        showScreen('questions-reveal-screen');
    }

    function showOddOneOut() {
        const oddOneName = gameState.oddOneName || gameState.players[gameState.oddOneIndex];
        const oddQuestion = gameState.oddQuestion;
        document.getElementById('odd-one-name').textContent = oddOneName;
        document.getElementById('odd-question-reveal').textContent = `"${oddQuestion}"`;
        showScreen('results-screen');
    }

    function playAgain() {
        if (gameState.mode === 'multiplayer') {
            if (!gameState.isHost) { alert('Only the host can start a new round!'); return; }
            const roomRef = database.ref('rooms/' + gameState.roomCode);
            roomRef.update({ gameStarted: false, phase: 'lobby', normalQuestion: null, oddQuestion: null, oddOneIndex: null, oddOneName: null, answers: null });
            gameState.phase = 'lobby';
            showScreen('lobby-screen');
        } else {
            gameState.currentPlayerIndex = 0;
            startGame();
        }
    }

    function resetGame() {
        if (gameState.mode === 'multiplayer' && database && gameState.roomCode) {
            if (gameState.isHost) { database.ref('rooms/' + gameState.roomCode).remove(); }
            else { database.ref('rooms/' + gameState.roomCode + '/players/' + sanitizeKey(gameState.playerName)).remove(); }
        }
        hardReset();
    }

    function showScreen(screenId) {
        const screens = ['mode-screen', 'join-screen', 'lobby-screen', 'setup-screen', 'question-screen', 'multiplayer-question-screen', 'answers-screen', 'discussion-screen', 'questions-reveal-screen', 'results-screen'];
        screens.forEach(screen => {
            const el = document.getElementById(screen);
            if (el) el.classList.add('hidden');
        });
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) targetScreen.classList.remove('hidden');
    }
</script>
</body>
</html>
